---
title: "Tracktics Analyse"
author: "Dr. JÃ¼rgen Walther"
date: "11/1/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(xlsx)
library(dplyr)
library(gridExtra)
library(grid)
library(gtable)
devtools::load_all()
```



```{r combine summary statistics, warning=FALSE,message=FALSE, echo=FALSE}

path <- "C://Users/Juergis/Documents/Fussball/Spielanalyse/Tracktics"
season <- "Saison2223"
full_path <- paste0(path, "/", season)


tracktics_files <- list.files(path = paste0(full_path), pattern = "*csv", full.names = TRUE)

tracktics_manuell <- tracktics_read_manual_csv(file = paste0(full_path, "/Tracktics_manuell.csv"))

data_tt <- do.call("cbind",lapply(1:(length(tracktics_files)-1), function(i) c(tracktics_read_team_stats(tracktics_files[i]), 
                                                                    tracktics_manuell[i,2:dim(tracktics_manuell)[2]]
                                                                    )
                       )
)

spiele <- obtain_match_names(file_path = full_path)

#spiele <- list.files(path = paste0(full_path), pattern = "*csv", full.names = FALSE)
#spiele <- substring(spiele, 1, nchar(spiele)-4)
#spiele <- spiele[-length(spiele)]

data_tt <- cbind(rownames(data_tt), data_tt)
rownames(data_tt) = NULL

# Ziele definieren
targets <- tracktics_define_targets(data_tt)
data_tt <- cbind(data_tt[,1], targets, data_tt[,2:dim(data_tt)[2]])

# Tabelle sortieren
data_tt <- data_tt[c(1:9, 19:21, 10:16, 26:28, 17, 22:25),]

red_match_names <- table_shorten_match_name(match_names = spiele)

colnames(data_tt) <- c("Tracktics Parameter", "Ziel", red_match_names)


# Save table
xlsx::write.xlsx(x = data_tt, file = paste0(full_path, "/Zusammenfassung/", Sys.Date(), "_Statistiken_kombiniert.xlsx"), row.names = FALSE)

df_data_tt <- as.data.frame(data_tt)
df_data_tt <- df_data_tt %>% dplyr::mutate_if(is.list, as.character)

# For every match add 100 in width
png(file = paste0(full_path, "/Zusammenfassung/", Sys.Date(), "_Statistiken_kombiniert.png"), height = 610, width = 450 + length(tracktics_files) * 72)
gridExtra::grid.table(df_data_tt, rows = NULL)
dev.off()
```

```{r einzelspieler analyse}

player_names <- tracktics_read_player_name(tracktics_files[length(tracktics_files)-1])

for(i in 1:nrow(player_names)){

first_name <- player_names$First.Name[i]
last_name <- player_names$Last.Name[i]

spiele <- obtain_match_names(file_path = full_path)
red_match_names <- table_shorten_match_name(match_names = spiele)

data_single <- do.call("cbind", lapply(1:(length(tracktics_files) - 1), function(i) tracktics_read_player_stats(file = tracktics_files[i], player_first_name = first_name, player_last_name = last_name, match_name = red_match_names[[i]])))

# Transform to table
colnames(data_single) <- c(data_single[1,])
data_single <- data_single[-1,]

data_single_tt <- cbind(rownames(data_single), data_single)
colnames(data_single_tt) <- c("Tracktics Paramter", colnames(data_single))


df_data_single_tt <- as.data.frame(data_single_tt)
df_data_single_tt <- df_data_single_tt %>% dplyr::mutate_if(is.list, as.character)

#Correct name for plotting
first_name <- tracktics_correct_names(name = first_name)
last_name <- tracktics_correct_names(name = last_name)

# Plot result
png(file = paste0(full_path, "/Einzelspieler/", first_name,"_",last_name, "_", Sys.Date(),".png"), height = 540, width = 320 + (ncol(df_data_single_tt)-1) * 75)
table <- tableGrob(df_data_single_tt, rows = NULL)
title <- textGrob(paste0(first_name, " ", last_name), gp = gpar(fontsize = 40))
padding <- unit(1,"line")
table <- gtable_add_rows(
  table, heights = grobHeight(title) + padding, pos = 0
)
table <- gtable_add_grob(
  table, list(title),
  t = 1, l = 1, r = ncol(table)
)
grid.newpage()
grid.draw(table)
dev.off()
}

```
