---
title: "Spielanalyse Zusammenfassung"
author: "Dr. Jürgen Walther"
date: "9/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load packages, warning=FALSE,message=FALSE, echo=FALSE}
# Main modules
library(dplyr)
# library(data.table)
library(ggplot2)
# library(dataPreparation)
# Modules for specific functions
library(tidyr)
# library(plotly)
# library(soccermatics)
# Plot moduless
library(pracma)
library(MASS)
library(ggforce)
library(cowplot)
# Save modules
library(xlsx)
```

# Daten laden

```{r load data, warning=FALSE,message=FALSE, echo=FALSE}

path <- "C://Users/Juergis/Documents/Fussball/Spielanalyse/Programm/Videoanalyse/WFV"
spiel <- "20200905_Seligenporten-WFV"
# Spielrichtung im realen Spiel
spielrichtung_real <- c(rep("r", 3), rep("l", 3)) # Die Spielrichtung in der Analyse ist immer von links nach rechts, also "r". Bei anderer Spielrichtung wird das Feld gespiegelt.

filenames <- c("paesse", "schuesse", "schuesse_gegner")

all_data <- lapply(filenames, function(file) {
  footballmatchanalysis::load_all_sections(
    filename = file,
    spiel = spiel,
    path = path,
    num_sections = 6
  )
})



```

# Variablen definieren

```{r important variables, warning=FALSE,message=FALSE, echo=FALSE}

outfolder <- paste0(path, "/", spiel, "/Analyse")
# dir.create(outfolder, showWarnings = TRUE)

outfolder_pass <- paste0(outfolder,"/Paesse")
outfolder_balls <- paste0(outfolder,"/Balluebernahme")
outfolder_shots <- paste0(outfolder,"/Schuesse")
outfolder_tactics <- paste0(outfolder,"/Taktik")

arrhead <- "last"
```

# Normalize and mirror data

```{r mirror data, warning=FALSE,message=FALSE, echo=FALSE}

all_data_norm_mirrored <- lapply(1:length(all_data), function(i) {
  lapply(1:length(all_data[[i]]), function(x) {
    footballmatchanalysis::mirror_sequences(
      footballmatchanalysis::normalize_sequences(all_data[[i]][[x]]),
      spielrichtung_real = spielrichtung_real[x]
    )
  })
})

pass <- all_data_norm_mirrored[[1]]
shots <- all_data_norm_mirrored[[2]]
shots_opp <- all_data_norm_mirrored[[3]]
```



```{r create total data.frame, warning=FALSE,message=FALSE, echo=FALSE}

pass_tot <- merge_sequences(pass)

```

```{r plot passes}
for (i in 1:6) {
  plot_pass_heatmap(
    df = pass[[i]],
    outpath = outfolder_pass,
    name_heatmap = paste0("paesse_heatmap_", i),
    name_discrete = paste0("paesse_heatmap_diskret_", i),
    name_raw = paste0("paesse_rawdata_", i)
  )
}

plot_pass_heatmap(
    df = pass_tot,
    outpath = outfolder_pass,
    name_heatmap = paste0("paesse_heatmap_total"),
    name_discrete = paste0("paesse_heatmap_diskret_total"),
    name_raw = paste0("paesse_rawdata_total")
  )
```

```{r plot balls}
# Get balls won and balls lost
ls_balls_lost <- lapply(pass, balls_lost)
ls_balls_won <- lapply(pass, balls_won)

# Get total balls won and total balls lost
balls_lost_tot <- merge_sequences(ls_balls_lost)
balls_won_tot <- merge_sequences(ls_balls_won)

for (i in 1:6) {
  plot_balls(df = ls_balls_won[[i]], title = "Ballgewinne", subtitle = paste0("Position der Ballgewinne in Abschnitt ",i), outpath = outfolder_balls, filename = paste0("ballgewinne_", i))
  plot_balls(df = ls_balls_lost[[i]], title = "Ballverluste", subtitle = paste0("Position der Ballverluste in Abschnitt ",i), outpath = outfolder_balls, filename = paste0("ballverluste_", i))
}

plot_balls(df = balls_won_tot, title = "Ballgewinne", subtitle = paste0("Position der Ballgewinne im gesamten Spiel"), outpath = outfolder_balls, filename = paste0("ballgewinne_total"))
plot_balls(df = balls_lost_tot, title = "Ballverluste", subtitle = paste0("Position der Ballverluste im gesamten Spiel"), outpath = outfolder_balls, filename = paste0("ballverluste_total"))
```

```{r plot shots}

# Get total balls won and total balls lost
shots_tot <- merge_sequences(shots)
shots_opp_tot <- merge_sequences(shots_opp)

for (i in 1:6) {
  plot_shots(df = shots[[i]], title = "Schüsse", subtitle = paste0("Position der Schüsse in Abschnitt ",i), outpath = outfolder_shots, filename = paste0("schuesse_", i))
  plot_shots(df = shots_opp[[i]], title = "Schüsse des Gegners", subtitle = paste0("Position der Schüsse des Gegners in Abschnitt ",i), outpath = outfolder_shots, filename = paste0("schuesse_gegner_", i))
}

plot_shots(df = shots_tot, title = "Schüsse", subtitle = paste0("Position der Schüsse im gesamten Spiel"), outpath = outfolder_shots, filename = paste0("schuesse_total"))
plot_shots(df = shots_opp_tot, title = "Schüsse des Gegners", subtitle = paste0("Position der Schüsse des Gegners im gesamten Spiel"), outpath = outfolder_shots, filename = paste0("schuesse_gegner_total"))
```
```{r summary statistics}

summary_table <- summary_table(pass = pass_tot, shots = shots_tot, shots_opp = shots_opp_tot)
print(summary_table)
xlsx::write.xlsx(x = summary_table, file = paste0(outfolder,"/Zusammenfassung_Statistiken.xlsx"), row.names = FALSE)
```
